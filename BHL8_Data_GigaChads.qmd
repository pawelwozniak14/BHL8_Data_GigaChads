---
title: "Utrzymanie maszyn w funkcjonowaniu magazynu"
execute:
  echo: false
  warning: false
---

```{r}
library(tidyverse)
library(ggcorrplot)
library(gridExtra)

load("data/model_data.rda")
load("plots/eda_f.rda")
load("plots/eda_p.rda")
load("plots/eda_con.rda")
load("plots/pdp_plots.rda")
load("model_summary_table.rda")
```

## Zrozumienie danych

Wybrane przez nas zadanie analityczne dotyczy predykcji uszkodzenia maszyn magazynowych oraz analiza wrażliwości wybranych modeli.

Opracowywany zbiór danych zawiera następujące zmienne

-   UID - unikalny identyfikator

-   Product_ID - Numer seryjny produktu

-   Type - wariant jakościowy produktu

-   Air_temperature - temperatura powietrza w pokoju

-   Process_temperature - temperatura w której wykonywany jest proces

-   Rotational_speed - częstotliwość obrotowa

-   Torque - moment obrotowy

-   Tool_wear - czas pracy w minutach danego narzędzia

-   Machine_failure - czy wystąpiła usterka

Oraz wyszczególnione powody usterek:

-   TWF - tool wear failure - szkoda powstała w wyniku zużycie narzędzia

-   HDF - heat dissipation failure - szkoda powstała w wyniku dysypacji ciepła

-   PWF - power failure - usterka z powodów energetycznych

-   OSF - overstrain failure - przeciążenie maszyny

-   RNF - random failures - losowe uszkodzenia

```{r}
model.matrix(~0+., data=model_data[,-c(1:2)]) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
```

Z macierzy korelacji widać, że ustreki maszy (co logczine) skorelowane są z poszczególnymi typami problemów funkcjonowania, lecz co ciekawe losowe usterki nie mają żadnego wpływu na pracę maszyn.

Pozostałe silne korelacje również sa intuicyjnie logiczne tj. temperatura powietrza z temperaturą procesu oraz częstotliwość obrotowa z momentem obrotowym.

```{r}
grid.arrange(p1,p2,ncol=1)
```

Wykresy rozkładu temperatur w przypadku powietrza sugeruje platokurtyczność oraz dla usterek maszyn dwumodalność z częstszym występowaniem w wyższych zakresach. Podobne zjawisko można zaobserwować dla temperatury procesu lecz kurtoza bliższa jest rozkładu normalnego dzięki czemu dla rozkładu w których występowały usterki uwydacznia się lewostronna asymetria. Możliwe że konieczne będzie transformowanie zmiennych dla lepszych rezultatów.

```{r}
grid.arrange(p3,p4,ncol=1)
```

Rozkłady częstotliwości obrotowej niezależnie od występowania usterki maszyny kształtem przypominają rozkład $\chi^2$ ze względu na bardzo silną asymetrię prawostronną. Natomiast w przypadku momentu obrotowego dla braku usterki rozkład kształtem przypomina dzwon Gaussa ze średnią 40. Powyżej tej wartości w rozkładzie obserwacji, gdzie wystąpiła usterka widać nagły wzrost częstości występowania uszkodzeń.

```{r}
grid.arrange(p5,p6,ncol=1)
```

Rozkład zużycia narzędzia do dwusetnej minuty jest jednostajny, natomiast powyżej tej wartości następuje gwałtowny wzrost częstotliwości występowania usterek, pozwala to podejrzewać że jest to istotna zmienna w kontekście utrzymania maszyn.

Dodatkowo widać bardzo silne niezbalansowanie klas w przypadku usterek, będzie to wymagało uwzględnienia w przypadku budowania modeli uczenia maszynowego, szczególnie że jesto to zmienna która będzie przewidywana i dookoła której prowadzona będzie optymalizacja.

```{r fig.width = 20, fig.height = 8}
grid.arrange(con1,con2,ncol=2)
```

```{r}
f1
```

Najczęściej występującym typem usterki jest ta powstała w wyniku dyssypacji ciepła, drugim najczęstszym powodem wystąpienia usterek jest przeciążenie maszyny w nieznacznie mniejszej ilości przypadków jest to usterka z przyczyn energetycznych. Znacząco rzedziej występującym czynnikiem jest zużycie narzędzia, najrzadziej występujacą przyczyną są losowe uszkodzenia.

## Budowa modeli uczenia maszynowego

Ze względu na silne niezrównoważenie klas zaobserwowane w części eksploracyjnej zdecydowaliśmy się na zastosowanie metody upsamplingu w technice SMOTE (Synthetic Minority Oversampling Technique) chcąc uniknąć zjawiska nadmiernego dopasowania przy jednoczesnym zachowaniu jakości predykcji.

Modele uczenia maszynowego zbudowane na cele zadania:

-   *Random Forest*

-   *Decision Tree*

-   *Support Vector Machine*

-   *K-Nearest Neighbors*

-   *Bagging*

-   *XGBoost*

-   *Logistic Regression*

Istotnym celem budowy powyższych modeli jest jak najlepsza jakość predykcyjna.
Jest ona potrzebna do poprawnego wnioskowania podczas analizy wrażliwości - w końcu, czy moglibyśmy zaufać takiej analizie bez zbudowania bardzo dobrego modelu?
Uznajemy, że w logistyce bardzo ważna jest sprawność maszyn i celem nadrzędnym jest maksymalizacja specificity, co sprawi, że jeśli nasza predykcja będzie się mylić to będzie to robić częściej w taki sposób, że będziemy obawiać się usterki, mimo że ona się nie wydarzy, za to będzie niewiele przypadków, gdzie umknie nam zagrożenie.
Uchronienie maszyny przed zepsuciem nie tylko sprawia, że oszczędzimy pieniądze na naprawie, ale również magazyn będzie bardziej efektywny, ponieważ nie stracimy ważnego narzędzia na czas naprawy.

Dostroiliśmy hiperparametry modeli korzystając z walidacji krzyżowej, przeszukiwania siatki latin hypercube oraz optymalizując wyniki modelu pod względem specificity.
Miary dopasowania dla wyżej wymienionych modeli wyglądają następująco:

```{r}
summary_table %>% 
  flextable::flextable()
```

Krzywe AUC-ROC

```{r}
curve <- readRDS("plots/curve.rds")
curve
```

Do analizy wrażliwości wybraliśmy Random Forest ze względu na dobry wynik AUC-ROC, Decision Tree ze względu na najlepszy wynik specificity oraz Support Vector Machines i XGBoost ze względu na drugi oraz trzeci wynik ze względu na AUC-ROC i specificity.

## Kontrola jakości i analiza wyników

```{r fig.height=9.5}
readRDS("plots/vip_plot.rds")
```

```{r fig.width=8}
#| layout-ncol: 2
pdp1
pdp2
pdp3
pdp4
pdp5
pdp6
```

